services:
  redis:
    image: redis:8.2.4-alpine3.22
    container_name: chess-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    networks:
      - chess-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  puzzle-generator:
    build:
      context: ./services/puzzle-generator
      dockerfile: Dockerfile
    container_name: puzzle-generator
    restart: unless-stopped
    ports:
      - "${PUZZLE_GENERATOR_PORT:-8080}:8080"
    env_file:
      - ./services/puzzle-generator/.env
    environment:
      SERVER_PORT: "8080"
      SERVER_READ_TIMEOUT: "15s"
      SERVER_WRITE_TIMEOUT: "120s"
      REDIS_URL: "redis://redis:6379"
      LICHESS_BASE_URL: "${LICHESS_BASE_URL:-https://lichess.org}"
      LICHESS_TIMEOUT: "10s"
      NVIDIA_BASE_URL: "${NVIDIA_BASE_URL:-https://integrate.api.nvidia.com/v1}"
      NVIDIA_MODEL: "${NVIDIA_MODEL:-meta/llama-3.3-70b-instruct}"
      NVIDIA_TIMEOUT: "${NVIDIA_TIMEOUT:-30s}"
      HUGGINGFACE_BASE_URL: "${HUGGINGFACE_BASE_URL:-https://datasets-server.huggingface.co}"
      HUGGINGFACE_DATASET: "${HUGGINGFACE_DATASET:-Lichess/chess-puzzles}"
      HUGGINGFACE_DATASET_CONFIG: "${HUGGINGFACE_DATASET_CONFIG:-default}"
      HUGGINGFACE_DATASET_SPLIT: "${HUGGINGFACE_DATASET_SPLIT:-train}"
      HUGGINGFACE_TIMEOUT: "${HUGGINGFACE_TIMEOUT:-15s}"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - chess-net
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  redis-data:


networks:
  chess-net:
    driver: bridge
